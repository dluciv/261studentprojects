package dk.archivator;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.HashMap;
import java.util.Vector;

public class Archivator {

	public static int FREQUENCY_SIZE = 256;

	private File inFile;
	private File outFile;
	private DataList frequencyList;
	private HashMap<Integer, Vector<Integer>> codeList;
	private HashMap<Integer, Integer> codesLength;
	private int maxCodeLength;
	private int restBits;

	/*
	 * CREATE TREE AND CODES
	 */
	public Archivator(String filePath) throws IOException {

		inFile = new File(filePath);

		String outFilePath = filePath.substring(0, filePath.length() - 4);
		System.out.println(outFilePath);
		outFile = new File(outFilePath + ".dk90");
		frequencyList = new DataList(FREQUENCY_SIZE, 0);
		readFile();
		HuffmanTree tree = new HuffmanTree(frequencyList);
		
		if(tree.getTreeSize() != 0){
		
		codesLength = tree.getLenghtCode();
		maxCodeLength = tree.getMaxCodeLength();
		codeList = tree.getCanonicalCode(codesLength);
		System.out.println(codeList);
		restBits = 0;

		for (int i = 0; i < frequencyList.size(); i++) {
			int frequency = frequencyList.getData(i);
			if (frequency != 0) {
				restBits += frequency * codeList.get(i).size();
			}
		}
		//System.out.println(restBits);
		restBits = restBits % 8;
		
		//System.out.println(restBits);
		
		writeFile();
		}
		else{
			outFile.createNewFile();
		}
	}

	/*
	 * READ FILE
	 */
	public void readFile() throws IOException {
		try {
			FileInputStream in = new FileInputStream(inFile);
			int c = 0;
			while ((c = in.read()) != -1) {
				frequencyList.addData(c);
			}
			in.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	/*
	 * WRITE FILE
	 */
	public void writeFile() throws IOException {
		try {
			BitOutputStream out = new BitOutputStream();
			out.writeFile(inFile, outFile, restBits,maxCodeLength,codesLength, codeList);
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	public HashMap<Integer, Vector<Integer>> getCodeList() {
		return codeList;
	}

	public int getRestBits() {
		return restBits;
	}

}
